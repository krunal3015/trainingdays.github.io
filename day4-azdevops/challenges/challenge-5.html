<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Challenge 5: Build and deploy the SCM Frontend | Azure Developer College</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="">
    
    <link rel="preload" href="/trainingdays/assets/css/0.styles.307428eb.css" as="style"><link rel="preload" href="/trainingdays/assets/js/app.aadb985f.js" as="script"><link rel="preload" href="/trainingdays/assets/js/2.60b29ab2.js" as="script"><link rel="preload" href="/trainingdays/assets/js/50.ee890255.js" as="script"><link rel="prefetch" href="/trainingdays/assets/js/10.ef037fa3.js"><link rel="prefetch" href="/trainingdays/assets/js/11.9cae77fb.js"><link rel="prefetch" href="/trainingdays/assets/js/12.1dee6588.js"><link rel="prefetch" href="/trainingdays/assets/js/13.0a9f95a6.js"><link rel="prefetch" href="/trainingdays/assets/js/14.bd4cb89a.js"><link rel="prefetch" href="/trainingdays/assets/js/15.aef07f31.js"><link rel="prefetch" href="/trainingdays/assets/js/16.d397cb42.js"><link rel="prefetch" href="/trainingdays/assets/js/17.f60ffbde.js"><link rel="prefetch" href="/trainingdays/assets/js/18.8b4893f4.js"><link rel="prefetch" href="/trainingdays/assets/js/19.bc84f6e9.js"><link rel="prefetch" href="/trainingdays/assets/js/20.7f91f739.js"><link rel="prefetch" href="/trainingdays/assets/js/21.9374c25b.js"><link rel="prefetch" href="/trainingdays/assets/js/22.23be2eb6.js"><link rel="prefetch" href="/trainingdays/assets/js/23.0d4c3084.js"><link rel="prefetch" href="/trainingdays/assets/js/24.6b0f8a59.js"><link rel="prefetch" href="/trainingdays/assets/js/25.d9be72bd.js"><link rel="prefetch" href="/trainingdays/assets/js/26.c1d3531e.js"><link rel="prefetch" href="/trainingdays/assets/js/27.05b277bd.js"><link rel="prefetch" href="/trainingdays/assets/js/28.ec6fb586.js"><link rel="prefetch" href="/trainingdays/assets/js/29.636b543c.js"><link rel="prefetch" href="/trainingdays/assets/js/3.eb7ad9cb.js"><link rel="prefetch" href="/trainingdays/assets/js/30.c6231c73.js"><link rel="prefetch" href="/trainingdays/assets/js/31.226f716f.js"><link rel="prefetch" href="/trainingdays/assets/js/32.b557d5f3.js"><link rel="prefetch" href="/trainingdays/assets/js/33.285d70c0.js"><link rel="prefetch" href="/trainingdays/assets/js/34.36b8dcb9.js"><link rel="prefetch" href="/trainingdays/assets/js/35.12f6fca5.js"><link rel="prefetch" href="/trainingdays/assets/js/36.1173a559.js"><link rel="prefetch" href="/trainingdays/assets/js/37.d36b3d79.js"><link rel="prefetch" href="/trainingdays/assets/js/38.47b7707b.js"><link rel="prefetch" href="/trainingdays/assets/js/39.4b3e088e.js"><link rel="prefetch" href="/trainingdays/assets/js/4.041e61ec.js"><link rel="prefetch" href="/trainingdays/assets/js/40.17e62bcd.js"><link rel="prefetch" href="/trainingdays/assets/js/41.111266c5.js"><link rel="prefetch" href="/trainingdays/assets/js/42.44835aad.js"><link rel="prefetch" href="/trainingdays/assets/js/43.54f81096.js"><link rel="prefetch" href="/trainingdays/assets/js/44.5541b061.js"><link rel="prefetch" href="/trainingdays/assets/js/45.40e8eedc.js"><link rel="prefetch" href="/trainingdays/assets/js/46.655536dc.js"><link rel="prefetch" href="/trainingdays/assets/js/47.0322317f.js"><link rel="prefetch" href="/trainingdays/assets/js/48.010da0c2.js"><link rel="prefetch" href="/trainingdays/assets/js/49.1ecc3330.js"><link rel="prefetch" href="/trainingdays/assets/js/5.646f1cf0.js"><link rel="prefetch" href="/trainingdays/assets/js/51.5850c36f.js"><link rel="prefetch" href="/trainingdays/assets/js/52.6f5bb109.js"><link rel="prefetch" href="/trainingdays/assets/js/53.5259bc3d.js"><link rel="prefetch" href="/trainingdays/assets/js/54.35a1dc4e.js"><link rel="prefetch" href="/trainingdays/assets/js/55.89a931e2.js"><link rel="prefetch" href="/trainingdays/assets/js/56.b355c4ae.js"><link rel="prefetch" href="/trainingdays/assets/js/57.b3fb7ce7.js"><link rel="prefetch" href="/trainingdays/assets/js/58.515eeec5.js"><link rel="prefetch" href="/trainingdays/assets/js/59.1a52ff8c.js"><link rel="prefetch" href="/trainingdays/assets/js/6.4e2c97c9.js"><link rel="prefetch" href="/trainingdays/assets/js/60.4fec80a1.js"><link rel="prefetch" href="/trainingdays/assets/js/61.9c7ab557.js"><link rel="prefetch" href="/trainingdays/assets/js/62.e645193c.js"><link rel="prefetch" href="/trainingdays/assets/js/63.64a97c42.js"><link rel="prefetch" href="/trainingdays/assets/js/64.abfd4514.js"><link rel="prefetch" href="/trainingdays/assets/js/65.33e6f1e8.js"><link rel="prefetch" href="/trainingdays/assets/js/66.32cf2ec7.js"><link rel="prefetch" href="/trainingdays/assets/js/67.2274ad3a.js"><link rel="prefetch" href="/trainingdays/assets/js/68.96d53205.js"><link rel="prefetch" href="/trainingdays/assets/js/69.16a7c700.js"><link rel="prefetch" href="/trainingdays/assets/js/7.e4fd8e8d.js"><link rel="prefetch" href="/trainingdays/assets/js/70.a2cb6abe.js"><link rel="prefetch" href="/trainingdays/assets/js/71.b936056c.js"><link rel="prefetch" href="/trainingdays/assets/js/72.676aa663.js"><link rel="prefetch" href="/trainingdays/assets/js/73.58bf868e.js"><link rel="prefetch" href="/trainingdays/assets/js/74.21dfc6ad.js"><link rel="prefetch" href="/trainingdays/assets/js/75.8e0f2651.js"><link rel="prefetch" href="/trainingdays/assets/js/76.03de1511.js"><link rel="prefetch" href="/trainingdays/assets/js/77.1ce66e3e.js"><link rel="prefetch" href="/trainingdays/assets/js/78.c2a7eaf1.js"><link rel="prefetch" href="/trainingdays/assets/js/79.695f838d.js"><link rel="prefetch" href="/trainingdays/assets/js/8.7928347b.js"><link rel="prefetch" href="/trainingdays/assets/js/80.71ac2b0b.js"><link rel="prefetch" href="/trainingdays/assets/js/81.6991f07a.js"><link rel="prefetch" href="/trainingdays/assets/js/82.43bf4248.js"><link rel="prefetch" href="/trainingdays/assets/js/83.0dfbc362.js"><link rel="prefetch" href="/trainingdays/assets/js/84.f58b218d.js"><link rel="prefetch" href="/trainingdays/assets/js/85.cf99b576.js"><link rel="prefetch" href="/trainingdays/assets/js/86.fea1b9f5.js"><link rel="prefetch" href="/trainingdays/assets/js/87.846cbf11.js"><link rel="prefetch" href="/trainingdays/assets/js/88.f079accd.js"><link rel="prefetch" href="/trainingdays/assets/js/89.89420005.js"><link rel="prefetch" href="/trainingdays/assets/js/9.ff630ec5.js"><link rel="prefetch" href="/trainingdays/assets/js/90.23b6b3e4.js">
    <link rel="stylesheet" href="/trainingdays/assets/css/0.styles.307428eb.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/trainingdays/" class="home-link router-link-active"><!----> <span class="site-name">Azure Developer College</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"> <a href="https://github.com/azuredevcollege/trainingdays" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"> <a href="https://github.com/azuredevcollege/trainingdays" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/trainingdays/" aria-current="page" class="sidebar-link">Home</a></li><li><a href="/trainingdays/day1/" class="sidebar-link">Day 1 Azure Fundamentals &amp; Infrastructure</a></li><li><a href="/trainingdays/day2/" class="sidebar-link">Day 2 Azure Development</a></li><li><a href="/trainingdays/day3/" class="sidebar-link">Day 3 Data and AI</a></li><li><a href="/trainingdays/day4/" class="sidebar-link">Day 4 DevOps and Monitoring</a></li><li><a href="/trainingdays/day5/" class="sidebar-link">Day 5 Identity and Architecture</a></li><li><a href="/trainingdays/day6/" class="sidebar-link">Day 6 Containerization</a></li><li><a href="/trainingdays/day7/" class="sidebar-link">Day 7 Kubernetes</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="challenge-5-build-and-deploy-the-scm-frontend"><a href="#challenge-5-build-and-deploy-the-scm-frontend" class="header-anchor">#</a> Challenge 5: Build and deploy the SCM Frontend</h1> <p><img src="/trainingdays/assets/img/pipelines.0565036c.svg" alt="Azure Pipelines"></p> <h2 id="here-is-what-you-will-learn-🎯"><a href="#here-is-what-you-will-learn-🎯" class="header-anchor">#</a> Here is what you will learn 🎯</h2> <ul><li>Create a CI build to create SCM Frontend's deployment artifacts</li> <li>Create a <em>Pull Request</em> validation build, that is triggered to validate a <em>Pull Request</em></li> <li>Create a CD Build to deploy SCM Frontend to the stages <em>Development</em> and <em>Testing</em></li></ul> <h2 id="table-of-contents"><a href="#table-of-contents" class="header-anchor">#</a> Table of Contents</h2> <ol><li><a href="#create-the-ci-build">Create the CI Build</a></li> <li><a href="#create-the-pull-request-validation-build">Create the Pull Request Validation Build</a></li> <li><a href="#create-the-cd-build">Create the CD Build</a></li> <li><a href="#create-a-pull-request">Create a Pull Request</a></li> <li><a href="#trigger-the-pr-build-to-validate-a-pull-request">Trigger the PR-Build to validate a Pull Request</a></li> <li><a href="#see-the-build-flow-in-action">See the Build Flow in Action</a></li> <li><a href="#wrap-up">Wrap-Up</a></li></ol> <h2 id="create-the-ci-build"><a href="#create-the-ci-build" class="header-anchor">#</a> Create the CI Build</h2> <p>Go to Azure Boards and set the User Story S14 and S15 to active. We create a new build definition with the steps as follows:</p> <ul><li>Build the SCM Frontend</li> <li>Copy the ARM Template to the artifact location</li> <li>Publish the artifacts</li></ul> <ol><li>Create a feature branch <em>&quot;features/scmfrontendcicd&quot;</em> and check it out</li> <li>Add a file named <code>scm-frontend-ci.yaml</code> in the directory <code>day4-azdevops/apps/pipelines</code></li> <li>Add the following yaml snippet that defines the build trigger:</li></ol> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">pr</span><span class="token punctuation">:</span> none
<span class="token key atrule">trigger</span><span class="token punctuation">:</span>
  <span class="token key atrule">branches</span><span class="token punctuation">:</span>
    <span class="token key atrule">include</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> master
  <span class="token key atrule">paths</span><span class="token punctuation">:</span>
    <span class="token key atrule">include</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> day4<span class="token punctuation">-</span>azdevops/apps/frontend/*
      <span class="token punctuation">-</span> day4<span class="token punctuation">-</span>azdevops/apps/infrastructure/templates/scm<span class="token punctuation">-</span>fe.json
</code></pre></div><p>Here we specified when the build must be triggered. The build is triggered only if changes were made to the master branch and when the changes were made to either <code>_day4-azdevops/apps/infrastructure/templates/scm-fe.json_</code> or to any files in the directory <code>_day4-azdevops/apps/frontend/\*_</code></p> <ol start="4"><li>Add the following yaml snippet to define the needed build steps:</li></ol> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">steps</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">task</span><span class="token punctuation">:</span> Npm@1
    <span class="token key atrule">inputs</span><span class="token punctuation">:</span>
      <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token string">'install'</span>
      <span class="token key atrule">workingDir</span><span class="token punctuation">:</span> <span class="token string">'day4-azdevops/apps/frontend/scmfe'</span>
  <span class="token punctuation">-</span> <span class="token key atrule">task</span><span class="token punctuation">:</span> Npm@1
    <span class="token key atrule">inputs</span><span class="token punctuation">:</span>
      <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token string">'custom'</span>
      <span class="token key atrule">workingDir</span><span class="token punctuation">:</span> <span class="token string">'day4-azdevops/apps/frontend/scmfe'</span>
      <span class="token key atrule">customCommand</span><span class="token punctuation">:</span> <span class="token string">'run build'</span>
  <span class="token punctuation">-</span> <span class="token key atrule">task</span><span class="token punctuation">:</span> CopyFiles@2
    <span class="token key atrule">inputs</span><span class="token punctuation">:</span>
      <span class="token key atrule">SourceFolder</span><span class="token punctuation">:</span> <span class="token string">'day4-azdevops/apps/frontend/scmfe/dist'</span>
      <span class="token key atrule">Contents</span><span class="token punctuation">:</span> <span class="token string">'**'</span>
      <span class="token key atrule">TargetFolder</span><span class="token punctuation">:</span> <span class="token string">'$(Build.ArtifactStagingDirectory)/dist'</span>
  <span class="token punctuation">-</span> <span class="token key atrule">task</span><span class="token punctuation">:</span> CopyFiles@2
    <span class="token key atrule">inputs</span><span class="token punctuation">:</span>
      <span class="token key atrule">sourceFolder</span><span class="token punctuation">:</span> day4<span class="token punctuation">-</span>azdevops/apps/infrastructure/templates
      <span class="token key atrule">contents</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
        scm-fe.json</span>
      <span class="token key atrule">targetFolder</span><span class="token punctuation">:</span> $(Build.ArtifactStagingDirectory)/templates
  <span class="token punctuation">-</span> <span class="token key atrule">task</span><span class="token punctuation">:</span> PublishPipelineArtifact@1
    <span class="token key atrule">inputs</span><span class="token punctuation">:</span>
      <span class="token key atrule">targetPath</span><span class="token punctuation">:</span> $(Build.ArtifactStagingDirectory)
      <span class="token key atrule">artifactName</span><span class="token punctuation">:</span> drop
</code></pre></div><ol start="5"><li>Commit your changes and push the branch to your remote repository</li> <li>Navigate to your Azure DevOps project</li> <li>In your project navigate to the Pipelines page. Then choose the action to create a new Pipeline</li> <li>Walk through the steps of the wizard by first selecting Azure Repos Git as the location of your source code</li> <li>Select your college repository</li> <li>Select <em>&quot;Existing Azure Pipelines YAML file&quot;</em></li> <li>Select your feature branch and specify the path: <em>&quot;/day4/apps/pipelines/scm-frontend-ci.yaml&quot;</em></li> <li>Run your CI Build by clicking the action <em>&quot;Run&quot;</em></li> <li>Rename your CI Build to <em>&quot;SCM-Frontend-CI&quot;</em></li> <li>Navigate to the Pipelines page and open the last run of the build <em>&quot;SCM-Frontend-CI&quot;</em>. You see that the artifact is linked to your build</li></ol> <h2 id="create-the-pull-request-validation-build"><a href="#create-the-pull-request-validation-build" class="header-anchor">#</a> Create the Pull Request Validation Build</h2> <p>In <a href="/trainingdays/day4-azdevops/challenges/challenge-2.html">Challenge 2</a> we configured the master branch's policies to require a <em>Pull Request</em> before changes are merged into the master.
With Azure Pipelines you can define a build that is executed whenever a Pull Request is created in order to validate a merge into the master branch.</p> <ol><li>Add a file named <code>scm-frontend-pr.yaml</code> in the directory <code>day4/apps/pipelines</code></li> <li>Add the following yaml snippet:</li></ol> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">trigger</span><span class="token punctuation">:</span> none
<span class="token key atrule">steps</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">task</span><span class="token punctuation">:</span> Npm@1
    <span class="token key atrule">inputs</span><span class="token punctuation">:</span>
      <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token string">'install'</span>
      <span class="token key atrule">workingDir</span><span class="token punctuation">:</span> <span class="token string">'day4-azdevops/apps/frontend/scmfe'</span>
  <span class="token punctuation">-</span> <span class="token key atrule">task</span><span class="token punctuation">:</span> Npm@1
    <span class="token key atrule">inputs</span><span class="token punctuation">:</span>
      <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token string">'custom'</span>
      <span class="token key atrule">workingDir</span><span class="token punctuation">:</span> <span class="token string">'day4-azdevops/apps/frontend/scmfe'</span>
      <span class="token key atrule">customCommand</span><span class="token punctuation">:</span> <span class="token string">'run build'</span>
</code></pre></div><ol start="3"><li>Commit your changes and push the branch to your remote repository</li> <li>Navigate to your Azure DevOps project</li> <li>In your project navigate to the Pipelines page. Then choose the action to create a new pipeline</li> <li>Walk through the steps of the wizard by first selecting Azure Repos Git as the location of your source code</li> <li>Select your college repository</li> <li>Select <em>&quot;Existing Azure Pipelines YAML file&quot;</em></li> <li>Select your feature branch and specify the path: <em>&quot;/day4-azdevops/apps/pipelines/scm-frontend-pr.yaml&quot;</em></li> <li>Run your PR Build by clicking the action <em>&quot;Run&quot;</em></li> <li>Rename your PR Build to <em>&quot;SCM-Frontend-PR&quot;</em></li></ol> <h2 id="create-the-cd-build"><a href="#create-the-cd-build" class="header-anchor">#</a> Create the CD Build</h2> <p>Now we have created the deployment artifacts with the build <em>SCM-Frontend-CI</em>. It is time to create a Release pipeline to deploy the SCM Frontend to Azure. As in <a href="/trainingdays/day4-azdevops/challenges/challenge-3.html">Challenge 3</a> we deploy the artifacts to the stages <em>Development</em> and <em>Testing</em> and we create a manual <em>Pre-deployment condition</em> to approve the deployment to the <em>Testing</em> stage.</p> <ol><li><p>Create a new release build and name it <em>SCM-Frontend-CD</em></p></li> <li><p>Add the SCM-Frontend-CI build's artifacts</p></li> <li><p>Create a <em>Development</em> stage</p></li> <li><p>Add the the following variables and replace <strong>'prefix'</strong> with your own value:</p> <table><thead><tr><th>Variable</th> <th>Value</th> <th>Scope</th></tr></thead> <tbody><tr><td>ResourceGroupName</td> <td>ADC-DAY4-SCM-DEV</td> <td>Development</td></tr> <tr><td>Location</td> <td>westeurope</td> <td>Development</td></tr> <tr><td>StorageAccountName</td> <td><em>{prefix}</em> day4scmfedev</td> <td>Development</td></tr> <tr><td>ApplicationInsightsName</td> <td>your ApplicationInsights instance name of stage Development</td> <td>Development</td></tr> <tr><td>ContactsEndpoint</td> <td>https endpoint of the SCM Contacts API in Development stage</td> <td>Development</td></tr> <tr><td>ResourcesEndpoint</td> <td><em>leave blank, will be needed later</em></td> <td>Development</td></tr> <tr><td>SearchEndpoint</td> <td><em>leave blank, will be needed later</em></td> <td>Development</td></tr> <tr><td>ReportsEndpoint</td> <td><em>leave blank, will be needed later</em></td> <td>Development</td></tr></tbody></table></li> <li><p>Go to the Tasks section of the <em>&quot;Development&quot;</em> stage and use the latest Ubuntu version to run the agent on</p></li> <li><p>Add the task <em>&quot;ARM template deployment&quot;</em></p></li> <li><p>Select your Azure Subscription</p></li> <li><p>Set the name of the ResourceGroup, use the variable $(ResourceGroupName)</p></li> <li><p>Set the Location, use the variable $(Location)</p></li> <li><p>Select the template from your drop location</p></li> <li><p>Override the template parameters as follow:</p> <div class="language-shell extra-class"><pre class="language-shell"><code>-storageAccountName <span class="token variable"><span class="token variable">$(</span>StorageAccountName<span class="token variable">)</span></span>
</code></pre></div></li> <li><p>Add three additional Azure CLI Tasks. To deploy the SCM Frontend Single Page Application to a staging environment we need to set the endpoints of the APIs and the InstrumentationKey of ApplicationInsights. As we deploy the single application to a storage account we need to enable the static website hosting for the storage account. Use the following Azure CLI tasks before the application is deployed to the storage account and after the Resource Group deployment task:</p> <ol><li><p>Azure CLI task &quot;Enable static website hosting&quot; inline script:</p> <div class="language-shell extra-class"><pre class="language-shell"><code>az storage blob service-properties update --account-name <span class="token variable"><span class="token variable">$(</span>StorageAccountName<span class="token variable">)</span></span> --static-website  --index-document index.html --404-document index.html
</code></pre></div></li> <li><p>Azure CLI task &quot;Configure SPA settings&quot; inline script:</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token builtin class-name">echo</span> <span class="token string">&quot;var uisettings = { <span class="token entity" title="\&quot;">\&quot;</span>enableStats<span class="token entity" title="\&quot;">\&quot;</span>: true, <span class="token entity" title="\&quot;">\&quot;</span>endpoint<span class="token entity" title="\&quot;">\&quot;</span>: <span class="token entity" title="\&quot;">\&quot;</span><span class="token variable"><span class="token variable">$(</span>ContactsEndpoint<span class="token variable">)</span></span><span class="token entity" title="\&quot;">\&quot;</span>, <span class="token entity" title="\&quot;">\&quot;</span>resourcesEndpoint<span class="token entity" title="\&quot;">\&quot;</span>: <span class="token entity" title="\&quot;">\&quot;</span><span class="token variable"><span class="token variable">$(</span>ResourcesEndpoint<span class="token variable">)</span></span><span class="token entity" title="\&quot;">\&quot;</span>, <span class="token entity" title="\&quot;">\&quot;</span>searchEndpoint<span class="token entity" title="\&quot;">\&quot;</span>: <span class="token entity" title="\&quot;">\&quot;</span><span class="token variable"><span class="token variable">$(</span>SearchEndpoint<span class="token variable">)</span></span><span class="token entity" title="\&quot;">\&quot;</span>, <span class="token entity" title="\&quot;">\&quot;</span>reportsEndpoint<span class="token entity" title="\&quot;">\&quot;</span>: <span class="token entity" title="\&quot;">\&quot;</span><span class="token variable"><span class="token variable">$(</span>ReportsEndpoint<span class="token variable">)</span></span><span class="token entity" title="\&quot;">\&quot;</span>, <span class="token entity" title="\&quot;">\&quot;</span>aiKey<span class="token entity" title="\&quot;">\&quot;</span>: <span class="token entity" title="\&quot;">\&quot;</span><span class="token variable"><span class="token variable">`</span>az resource show -g <span class="token punctuation">$(</span>ResourceGroupName<span class="token punctuation">)</span> -n <span class="token punctuation">$(</span>ApplicationInsightsName<span class="token punctuation">)</span> --resource-type <span class="token string">&quot;microsoft.insights/components&quot;</span> --query <span class="token string">&quot;properties.InstrumentationKey&quot;</span> -o tsv<span class="token variable">`</span></span><span class="token entity" title="\&quot;">\&quot;</span> };&quot;</span> <span class="token operator">&gt;</span> <span class="token variable"><span class="token variable">$(</span>System.ArtifactsDirectory<span class="token variable">)</span></span>/_SCM-Frontend-CI/drop/dist/settings/settings.js
</code></pre></div></li> <li><p>Azure CLI task &quot;Copy SPA to StorageAccount&quot; inline script:</p> <div class="language-shell extra-class"><pre class="language-shell"><code>az storage blob upload-batch -d <span class="token string">'$web'</span> --account-name <span class="token variable"><span class="token variable">$(</span>StorageAccountName<span class="token variable">)</span></span> -s <span class="token variable"><span class="token variable">$(</span>System.ArtifactsDirectory<span class="token variable">)</span></span>/_SCM-Frontend-CI/drop/dist
</code></pre></div></li></ol></li> <li><p>Save the release definition and create a release to check if everything works</p></li></ol> <h3 id="create-the-testing-stage"><a href="#create-the-testing-stage" class="header-anchor">#</a> Create the <em>Testing</em> stage</h3> <ol><li><p>Edit the Release definition and go to the task view</p></li> <li><p>Clone the <em>Development</em> stage and rename the cloned stage to <em>Testing</em></p></li> <li><p>Open the Release definition's variable view and add new variables as follow:</p> <table><thead><tr><th>Variable</th> <th>Value</th> <th>Scope</th></tr></thead> <tbody><tr><td>ResourceGroupName</td> <td>ADC-DAY4-SCM-TEST</td> <td>Testing</td></tr> <tr><td>Location</td> <td>westeurope</td> <td>Testing</td></tr> <tr><td>StorageAccountName</td> <td><em>{prefix}</em> day4scmfetest</td> <td>Testing</td></tr> <tr><td>ApplicationInsightsName</td> <td>your ApplicationInsights instance name of stage Testing</td> <td>Testing</td></tr> <tr><td>ContactsEndpoint</td> <td>https endpoint of the SCM Contacts API in Testing stage</td> <td>Testing</td></tr> <tr><td>ResourcesEndpoint</td> <td><em>leave blank, will be needed later</em></td> <td>Testing</td></tr> <tr><td>SearchEndpoint</td> <td><em>leave blank, will be needed later</em></td> <td>Testing</td></tr> <tr><td>ReportsEndpoint</td> <td><em>leave blank, will be needed later</em></td> <td>Testing</td></tr></tbody></table></li> <li><p>Save the definition and create a release</p></li></ol> <h2 id="create-a-pull-request"><a href="#create-a-pull-request" class="header-anchor">#</a> Create a Pull Request</h2> <p>Create a Pull Request and merge all changes into the master branch. Don't forget to link the User Stories S14 and S15.</p> <h2 id="trigger-the-pr-build-to-validate-a-pull-request"><a href="#trigger-the-pr-build-to-validate-a-pull-request" class="header-anchor">#</a> Trigger the PR-Build to validate a Pull Request</h2> <p>Now we have to enable the PR-Build to be triggered whenever a Pull Request is created and when files are changed that belongs to the SCM Frontend.</p> <ol><li><p>Open the branch policies of the master branch</p></li> <li><p>Add a build validation and select your SCM-Frontend-PR build</p></li> <li><p>Set the path filter as follow:</p> <div class="language-shell extra-class"><pre class="language-shell"><code>/day4-azdevops/apps/infrastructure/templates/scm-fe.json<span class="token punctuation">;</span>/day4-azdevops/apps/frontend/*
</code></pre></div><p>With this filter the PR build is only triggered when files were changed that belongs to the SCM Frontend</p></li> <li><p>Save your changes</p></li></ol> <h2 id="see-the-build-flow-in-action"><a href="#see-the-build-flow-in-action" class="header-anchor">#</a> See the Build Flow in Action</h2> <p>Now it's time to see the whole build flow in action.</p> <ol><li><p>Checkout the master branch and pull the latest changes</p></li> <li><p>Create and checkout a new feature branch <em>features/scmfrontendflow</em></p></li> <li><p>Open the file <a href="../apps/frontend/scmfe/src/components/home/Home.vue">day4/apps/frontend/scmfe/src/components/home/Home.vue</a> and change the name the <em>Welcome</em> text in line 13:</p> <div class="language-HTML extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>display-2 font-weight-bold mb-3<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Welcome to My SCM Contacts App<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
</code></pre></div></li> <li><p>Commit your changes and push the feature branch to your remote repository</p></li> <li><p>Create a <em>Pull Request</em> to merge the changes into the master branch. Don't forget to link the User Story S15.
You will see that the PR-Build is part of the required policies of your Pull Request
<img src="/trainingdays/assets/img/pr-build-validation.e0c6fcce.png" alt="PullRequest"></p></li> <li><p>Complete your Pull Request</p></li> <li><p>Navigate to the Pipelines view and you will notice that the SCM-Contacts-CI build is triggered
<img src="/trainingdays/assets/img/scm-frontend-ci.3bc698be.png" alt="SCM-Frontend-CI">
Wait until the build is finished and the deployment artifacts are available</p></li> <li><p>Navigate to the Release view and you will see that the CD Pipeline is triggered and starts to deploy the artifacts to the Development stage</p></li> <li><p>Go to Azure Boards and set the stories S14 and S15 to completed</p></li></ol> <h2 id="wrap-up"><a href="#wrap-up" class="header-anchor">#</a> Wrap-Up</h2> <p>🥳 <strong>Congratulation</strong> - You have completed the User Stories S14 and S15 🥳</p> <p>Now you have seen how you can create a Pull Request validation build that protects your master branch from build breaks. After changes are merged into the master branch, the CI build is triggered and it creates the deployment artifacts. The deployment artifacts are then deployed to your stages. After this challenge we have deployed the SCM Frontend to Azure. The SCM Contact API and SCM Frontend is running on Azure.</p> <p>Now that you have deployed the Frontend to Azure it's time to test it! Go to the Azure Portal and navigate to the ResourceGroup <code>ADC-DAY4-SCM-DEV</code>. Open the StorageAccount <code>{prefix} day4scmfedev</code> and go to Static website. Copy the url of the primary endpoint, open a new browser window and paste the url.</p> <p>If everything is configured correctly you can add some contacts.</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>📝 At the moment we have only deployed the SCM Contacts API and the SCM Frontend. It is not possible to set an image for a contact or to create visit reports.</p></div> <p><a href="/trainingdays/day4-azdevops/challenges/challenge-4.html">◀ Previous challenge</a> | <a href="/trainingdays/day4-azdevops/" class="router-link-active">🔼 Day 4</a> | <a href="/trainingdays/day4-azdevops/challenges/challenge-bo-1.html">Next challenge ▶</a></p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/azuredevcollege/trainingdays/edit/master/day4-azdevops/challenges/challenge-5.md" target="_blank" rel="noopener noreferrer">Edit this page</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/trainingdays/assets/js/app.aadb985f.js" defer></script><script src="/trainingdays/assets/js/2.60b29ab2.js" defer></script><script src="/trainingdays/assets/js/50.ee890255.js" defer></script>
  </body>
</html>
